<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片除錯頁面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .image-test { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .image-container { margin: 10px 0; }
        img { max-width: 300px; border: 1px solid #ddd; }
        .error { color: red; }
        .success { color: green; }
        .loading { color: orange; }
    </style>
</head>
<body>
    <h1>圖片載入除錯頁面</h1>
    
    <div class="image-test">
        <h3>1. 測試 Unsplash 圖片</h3>
        <div class="image-container">
            <p>維他命C 圖片:</p>
            <img src="https://source.unsplash.com/600x400/?vitamin" alt="維他命C" onload="this.nextElementSibling.textContent='✅ 載入成功'" onerror="this.nextElementSibling.textContent='❌ 載入失敗'">
            <span class="loading">載入中...</span>
        </div>
        
        <div class="image-container">
            <p>魚油圖片:</p>
            <img src="https://source.unsplash.com/600x400/?fish%20oil,supplements" alt="魚油" onload="this.nextElementSibling.textContent='✅ 載入成功'" onerror="this.nextElementSibling.textContent='❌ 載入失敗'">
            <span class="loading">載入中...</span>
        </div>
    </div>
    
    <div class="image-test">
        <h3>2. 測試 API 商品資料</h3>
        <button onclick="loadProductsFromAPI()">載入商品資料</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="image-test">
        <h3>3. 測試圖片路徑解析</h3>
        <button onclick="testImagePathResolution()">測試路徑解析</button>
        <div id="pathResult"></div>
    </div>
    
    <div class="image-test">
        <h3>4. 測試實際商品渲染</h3>
        <button onclick="testProductRendering()">測試商品渲染</button>
        <div id="renderResult"></div>
    </div>

    <script>
        function loadProductsFromAPI() {
            fetch('./products-public.php')
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        let html = '<h4>商品資料:</h4>';
                        data.products.forEach(product => {
                            html += `
                                <div style="border: 1px solid #eee; padding: 10px; margin: 10px 0;">
                                    <strong>${product.name}</strong><br>
                                    <small>ID: ${product.id}</small><br>
                                    <small>圖片: ${product.img || '無圖片'}</small><br>
                                    <img src="${product.img}" alt="${product.name}" style="max-width: 200px; margin-top: 5px;" 
                                         onload="this.style.border='2px solid green'" 
                                         onerror="this.style.border='2px solid red'; this.style.backgroundColor='#ffe6e6'">
                                </div>
                            `;
                        });
                        document.getElementById('apiResult').innerHTML = html;
                    } else {
                        document.getElementById('apiResult').innerHTML = '<p class="error">API 錯誤: ' + data.error + '</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('apiResult').innerHTML = '<p class="error">載入失敗: ' + error.message + '</p>';
                });
        }
        
        function testImagePathResolution() {
            const testPaths = [
                'https://source.unsplash.com/600x400/?vitamin',
                '/uploads/test.jpg',
                './uploads/test.jpg',
                'uploads/test.jpg',
                'test.jpg',
                ''
            ];
            
            let html = '<h4>路徑解析測試:</h4>';
            testPaths.forEach(path => {
                const resolved = resolveImageSrc(path);
                html += `<p><strong>原始:</strong> "${path}" → <strong>解析後:</strong> "${resolved}"</p>`;
            });
            
            document.getElementById('pathResult').innerHTML = html;
        }
        
        function resolveImageSrc(path) {
            if (!path) return '';
            const s = String(path).trim();
            if (/^https?:\/\//i.test(s)) return s; // absolute URL
            if (s.startsWith('/')) return s;        // site-root relative
            return `./${s.replace(/^\.?\/+/, '')}`; // relative to current
        }
        
        function testProductRendering() {
            const testProducts = [
                { id: 'test1', name: '測試商品1', desc: '測試描述1', img: 'https://source.unsplash.com/600x400/?vitamin' },
                { id: 'test2', name: '測試商品2', desc: '測試描述2', img: '/uploads/test.jpg' },
                { id: 'test3', name: '測試商品3', desc: '測試描述3', img: '' }
            ];
            
            let html = '<h4>商品渲染測試:</h4>';
            testProducts.forEach(product => {
                const hasImg = !!(product.img && String(product.img).trim() !== '');
                const src = hasImg ? resolveImageSrc(product.img) : '';
                
                html += `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px;">
                        <h5>${product.name}</h5>
                        <p>${product.desc}</p>
                        <p><strong>原始圖片路徑:</strong> "${product.img}"</strong></p>
                        <p><strong>是否有圖片:</strong> ${hasImg ? '是' : '否'}</strong></p>
                        <p><strong>解析後路徑:</strong> "${src}"</strong></p>
                        <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; min-height: 100px;">
                `;
                
                if (hasImg) {
                    html += `<img src="${src}" alt="${product.name}" style="max-width: 200px;" 
                                   onload="this.style.border='2px solid green'" 
                                   onerror="this.style.border='2px solid red'; this.style.backgroundColor='#ffe6e6'">`;
                } else {
                    html += '<div style="background: #e0e0e0; height: 100px; display: flex; align-items: center; justify-content: center; color: #666;">無圖片</div>';
                }
                
                html += '</div></div>';
            });
            
            document.getElementById('renderResult').innerHTML = html;
        }
    </script>
</body>
</html>
